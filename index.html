<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Perfetto Trace Launcher</title>
</head>
<body>
  <p id="status">Launching Perfetto…</p>
  <script>
    (async function() {
      const status = document.getElementById('status');
      const params = new URLSearchParams(location.search);
      const TRACE_URL = params.get('export');  // Drive’s download URL
      const FILE_NAME = params.get('name') || 'trace.json';

      if (!TRACE_URL) {
        status.textContent = 'Error: missing export URL';
        return;
      }
      status.textContent = 'Fetching trace…';

      try {
        // Include credentials so Drive’s auth cookie is sent
        const resp = await fetch(TRACE_URL, { credentials: 'include' });
        if (!resp.ok) throw new Error(resp.statusText);
        const buffer = await resp.arrayBuffer();

        status.textContent = 'Opening Perfetto UI…';
        const w = window.open('https://ui.perfetto.dev');
        if (!w) {
          status.textContent = 'Popup blocked – allow popups.';
          return;
        }

        // PING/PONG handshake
        const ping = () => w.postMessage('PING', '*');
        let pongHandler = e => {
          if (e.source === w && e.data === 'PONG') {
            window.removeEventListener('message', pongHandler);
            clearInterval(interval);
            status.textContent = 'Sending trace…';
            w.postMessage({
              perfetto: {
                buffer,
                title: FILE_NAME,
                fileName: FILE_NAME
              }
            }, '*');
            status.textContent = 'Done!';
          }
        };
        window.addEventListener('message', pongHandler);
        const interval = setInterval(ping, 100);

      } catch (err) {
        status.textContent = 'Error fetching trace: ' + err.message;
      }
    })();
  </script>
</body>
</html>

